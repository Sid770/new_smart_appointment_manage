name: Azure Deployment CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_WEBAPP_NAME: 'app-appointment-booking-api'
  AZURE_WEBAPP_PACKAGE_PATH: './AppointmentBookingAPI'
  OUTPUT_PATH: './publish'

jobs:
  
  # =============================================================================
  # BUILD AND TEST JOB
  # =============================================================================
  
  build-and-test:
    name: Build & Test .NET API
    runs-on: ubuntu-latest
    
    steps:
    - name: üõéÔ∏è Checkout code
      uses: actions/checkout@v4
    
    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: üì¶ Restore dependencies
      run: dotnet restore ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/AppointmentBookingAPI.csproj
    
    - name: üèóÔ∏è Build
      run: dotnet build ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/AppointmentBookingAPI.csproj --configuration Release --no-restore
    
    - name: üß™ Run unit tests
      run: dotnet test ./AppointmentBookingAPI.Tests/AppointmentBookingAPI.Tests.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
    
    - name: üìä Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: .NET Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        fail-on-error: false
    
    - name: üìù Publish build artifacts
      run: dotnet publish ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/AppointmentBookingAPI.csproj --configuration Release --output ${{ env.OUTPUT_PATH }}
    
    - name: üì§ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dotnet-app
        path: ${{ env.OUTPUT_PATH }}

  # =============================================================================
  # DEPLOY TO AZURE JOB
  # =============================================================================
  
  deploy-to-azure:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    steps:
    - name: üì• Download artifact
      uses: actions/download-artifact@v4
      with:
        name: dotnet-app
        path: ${{ env.OUTPUT_PATH }}
    
    - name: üöÄ Deploy to Azure Web App
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ${{ env.OUTPUT_PATH }}
    
    - name: ‚úÖ Deployment complete
      run: |
        echo "üéâ Deployment successful!"
        echo "üåê API URL: ${{ steps.deploy-to-webapp.outputs.webapp-url }}"
        echo "üìö Swagger: ${{ steps.deploy-to-webapp.outputs.webapp-url }}/swagger"

  # =============================================================================
  # HEALTH CHECK JOB
  # =============================================================================
  
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy-to-azure
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üè• Wait for app to warm up
      run: sleep 30
    
    - name: üîç Check API health
      run: |
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/timeslots)
        echo "Status code: $RESPONSE"
        if [ $RESPONSE -eq 200 ] || [ $RESPONSE -eq 404 ]; then
          echo "‚úÖ API is responding"
        else
          echo "‚ùå API health check failed"
          exit 1
        fi
    
    - name: üìö Verify Swagger endpoint
      run: |
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/swagger/index.html)
        echo "Swagger status: $RESPONSE"
        if [ $RESPONSE -eq 200 ]; then
          echo "‚úÖ Swagger is accessible"
        else
          echo "‚ö†Ô∏è Swagger might not be accessible (Status: $RESPONSE)"
        fi
